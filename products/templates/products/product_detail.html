{% extends "_base.html" %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}{{ product.name }}{% endblock title %}
{% block CSS %}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
{% endblock CSS %}

{% block content %}
<div class="container my-5">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/">خانه</a></li>
            {% if product.category %}
            <li class="breadcrumb-item"><a href="#">{{ product.category.name }}</a></li>
            {% endif %}
            <li class="breadcrumb-item active" aria-current="page">{{ product.name }}</li>
        </ol>
    </nav>
    <div class="row g-4">
        <div class="col-lg-6">
            <div class="border rounded-3 p-3 text-center shadow-sm">
                <img src="{{ product.image.url }}" class="img-fluid rounded-3" alt="{{ product.name }}">
            </div>
        </div>

        <div class="col-lg-6">
            <div class="product-details ps-lg-3">
                <h1 class="h3 mb-3">{{ product.name }}</h1>

                <div class="product-price-wrapper mb--30">
                    <span class="money text-success">قیمت : {{ product.price }}تومان</span>
                </div>
                <p class="mb-4 text-muted">{{ product.short_description }}</p>

                <div class="d-flex align-items-center mb-4">
                    <div class="me-3" style="width: 100px;">
                        <input type="number" value="1" class="form-control text-center" id="quantity-input">
                    </div>
                    <button class="btn btn-danger shadow-0" type="button">
                        <i class="bi bi-cart-plus-fill me-2"></i> اضافه به سبد خرید
                    </button>
                </div>
                
                <hr>

                <div class="product-meta">
                    {% if product.category %}
                    <p><strong>دسته بندی:</strong> <a href="#" class="text-decoration-none">{{ product.category.name }}</a></p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-5">
        <div class="col-12">
            <div class="border rounded-3 shadow-sm">
                <ul class="nav nav-tabs nav-fill mb-3" id="productTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="description-tab" data-bs-toggle="tab" data-bs-target="#description-pane" type="button" role="tab">توضیحات کامل</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="specs-tab" data-bs-toggle="tab" data-bs-target="#specs-pane" type="button" role="tab">ویژگی‌ها</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="reviews-tab" data-bs-toggle="tab" data-bs-target="#reviews-pane" type="button" role="tab">
                            نظرات <span class="badge rounded-pill bg-secondary">{{ comments.count }}</span>
                        </button>
                    </li>
                </ul>
                <div class="tab-content p-4" id="productTabContent">
                    <div class="tab-pane fade show active" id="description-pane" role="tabpanel">
                        {{ product.description|linebreaks }}
                    </div>
                    <div class="tab-pane fade" id="specs-pane" role="tabpanel">
                        {% if product.specifications %}
                            <table class="table table-striped table-bordered">
                                <tbody>
                                {% for key, value in product.specifications.items %}
                                    <tr>
                                        <th scope="row" class="w-25">{{ key }}</th>
                                        <td>{{ value }}</td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        {% else %}
                            <p class="text-muted">ویژگی برای این محصول ثبت نشده است.</p>
                        {% endif %}
                    </div>
                    <div class="tab-pane fade" id="reviews-pane" role="tabpanel">
                        <h4 class="mb-4">نظرات کاربران</h4>
                        <ul class="list-unstyled">
                            {% for comment in comments %}
                                {% include "partials/comment.html" with comment=comment %}
                            {% empty %}
                                <li class="alert alert-info">هنوز نظری برای این محصول ثبت نشده است. شما اولین نفر باشید!</li>
                            {% endfor %}
                        </ul>

                        <hr class="my-4">

                        <div id="comment-form-wrapper" class="review-form-wrapper">
                            <h4 id="reply-title" class="mb-3">نظر خود را بنویسید</h4>
                            <form action="" method="POST" novalidate>
                                {% csrf_token %}
                                {{ form|crispy }}
                                <button type="submit" class="btn btn-primary mt-3">ارسال نظر</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block scripts %}
<script>
function setParentId(event, parentId) {
    // مرحله ۱: از رفتار پیش‌فرض لینک (پریدن به #آدرس) جلوگیری می‌کنیم
    event.preventDefault();

    // مرحله ۲: مقدار فیلد مخفی 'parent' را در فرم کامنت تنظیم می‌کنیم
    document.querySelector('input[name="parent"]').value = parentId;
    
    // مرحله ۳: عنوان بالای فرم را تغییر می‌دهیم تا کاربر متوجه شود در حال پاسخ دادن است
    document.getElementById('reply-title').innerText = "در حال ارسال پاسخ...";

    // مرحله ۴: کاربر را به سمت فرم هدایت می‌کنیم
    const commentForm = document.getElementById('comment-form-wrapper');
    commentForm.scrollIntoView({ behavior: 'smooth', block: 'center' });

    // مرحله ۵: روی فیلد متن فوکوس می‌کنیم، اما با یک تاخیر کوتاه (۴۰۰ میلی‌ثانیه)
    // این تاخیر به مرورگر فرصت می‌دهد تا انیمیشن اسکرول را تمام کند
    const textarea = commentForm.querySelector('textarea[name="content"]');
    setTimeout(() => {
        textarea.focus();
    }, 400); 
}
</script>
{% endblock scripts %}